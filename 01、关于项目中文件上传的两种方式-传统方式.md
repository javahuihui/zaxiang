# 01.关于项目中文件上传的两种方式-本地上传



## 概述场景

文件上传，是程序开发中必须会使用到一个功能，比如：

- 添加商品，用户头像，文章封面等需求
- 富文本编辑（插件文件上传）

## 文件上传原理是什么？

为什么要实现文件上传，就要共享资源，大家都可以看你的在平台上上传的文件。就一句话：把用户的自己电脑中的文件，通过程序上传到服务器的过程!

![image-20211027202231774](asserts/image-20211027202231774.png)



其实就是一句话：把用户的文件通过javaio流程复制到服务器的过程，称之为文件上传。





## 03、使用springboot如何实现文件上传呢？

- 使用springboot完成的本地文件上传

  

### 01、实现步骤

#### 01、搭建一个springboot工程

#### 02、准备一个页面文件上传的页面

在resources/templates/upload.html

```yml
server:
  port: 8777


spring:
  freemarker:
    suffix: .html
    cache: false

```

#### 03、实现后台的文件上传

定义文件上传的servicce

```java
package com.kuangstudy.service;

import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;

@Service
public class UploadService {


    /**
     * MultipartFile 这个对象是springMvc提供的文件上传的接受的类，
     * 它的底层自动会去和HttpServletRequest request中的request.getInputStream()融合
     * 从而达到文件上传的效果。也就是告诉你一个道理：
     * 文件上传底层原理是：request.getInputStream()
     *
     * @param multipartFile
     * @param dir
     * @return
     */
    public String uploadImg(MultipartFile multipartFile, String dir) {
        // 1: 指定文件上传的目录
        File targetFile = new File("F://tmp/" + dir);
        try {
            if(!targetFile.exists())targetFile.mkdirs();
            // 2: 指定文件上传以后的目录
            File targetFileName = new File(targetFile,"aaa.png");
            // 2: 文件上传到指定的目录
            multipartFile.transferTo(targetFileName);
            return "ok";
        } catch (IOException e) {
            e.printStackTrace();
            return "fail";
        }
    }

}

```

定义一个文件上传的controller

```java
package com.kuangstudy.controller;

import com.kuangstudy.service.UploadService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;

@Controller
public class UploadController {


    @Autowired
    private UploadService uploadService;

    /**
     * 文件上传具体实现
     * @param multipartFile
     * @param request
     * @return
     */
    @PostMapping("/upload/file")
    @ResponseBody
    public String upload(@RequestParam("file") MultipartFile multipartFile, HttpServletRequest request){
        if(multipartFile.isEmpty()){
            return "文件有误!!!";
        }
        long size = multipartFile.getSize();
        String originalFilename = multipartFile.getOriginalFilename();
        String contentType = multipartFile.getContentType();//imgae/png;image/jpg;image/gif
//        if(!contentType.equals("png|jpg|gif")){ //伪代码 ，不正确的代码
//            return "文件类型不正确";
//        }
        // 1: 获取用户指定的文件夹。问这个文件夹为什么要从页面上传递过来呢?
        // 原因是：做隔离，不同业务，不同文件放在不同的目录中
        String dir = request.getParameter("dir");
        return uploadService.uploadImg(multipartFile,dir);
    }


}

```

定义一个页面

```html
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>文件上传</title>
</head>
<body>
    <h1>文件上传</h1>

    <form action="/upload/file" enctype="multipart/form-data" method="post">
         <input name="dir" value="bbs">
         <input name="file" type="file">
         <input type="submit" value="文件上传">
    </form>

</body>
</html>
```

点击文件上传，然后在后台看到如下代码：

![image-20211027204731016](asserts/image-20211027204731016.png)

springmvc中文件上传的提供了包装对象：MultipartFile 原理如下：

![image-20211027204620038](asserts/image-20211027204620038.png)

- 通过MultipartFile 我们很清楚的看到，文件已经被服务器接收。

- ==但是会产生一个临时目录，这个目录是可以去配置==

- ![image-20211027205902814](asserts/image-20211027205902814.png)

  文件上传不会直接上传真是的目录，它一定要经过一个临时目录的中转以后，才会上传到真是目录。作用：

  - 防止上传出现网络断开，或者用户上传直接刷新或者取消。因为如果用户的网络断开或者取消，就造成大量的垃圾文件
  - 保证真实目录上传的文件一定是有效的。

- ==文件上传的大小：也可以进行配置的==
- ==文件上传的类型：也是进行配置的==

```yml
server:
  port: 8777


spring:
  freemarker:
    suffix: .html
    cache: false
  servlet:
    multipart:
      enabled: true
      # 是单个文件大小 默认1M 10KB
      max-file-size: 2MB
      # 是设置总上传的数据大小
      max-request-size: 10MB
      #当文件达到多少时进行磁盘写入
      file-size-threshold: 20MB
      # 设置临时目录
      location: F://data//tempxxxxxxxxxxxx



```



#### 04、指定文件上传的目录

配置springboot静态资源存储服务，将上传的文件放入指定的目录中

```java
package com.kuangstudy.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletRequest;
import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.UUID;

@Service
public class UploadService {


    @Value("${file.uploadFolder}")
    private String uploadFolder;
    @Value("${file.staticPath}")
    private String staticPath;

    /**
     * MultipartFile 这个对象是springMvc提供的文件上传的接受的类，
     * 它的底层自动会去和HttpServletRequest request中的request.getInputStream()融合
     * 从而达到文件上传的效果。也就是告诉你一个道理：
     * 文件上传底层原理是：request.getInputStream()
     *
     * @param multipartFile
     * @param dir
     * @return
     */
    public String uploadImg(MultipartFile multipartFile, String dir) {
        try {
            String realfilename = multipartFile.getOriginalFilename(); // 上传的文件：aaa.jpg
            // 2:截图文件名的后缀
            String imgSuffix = realfilename.substring(realfilename.lastIndexOf("."));// 拿到：.jpg
            // 3:生成的唯一的文件名：能不能用中文名：不能因为统一用英文命名。
            String newFileName = UUID.randomUUID().toString()+imgSuffix;// 将aaa.jpg改写成：SD23423k324-23423ms.jpg
            // 4：日期目录
            SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy/MM/dd");
            String datePath = dateFormat.format(new Date());// 日期目录：2021/10/27
            // 5: 指定文件上传以后的目录
            String servrepath = uploadFolder;// 这不是tomcat服务目录，别人不认识
            File targetPath = new File(servrepath+dir,datePath);// 生成一个最终目录:F://tmp/avatar/2021/10/27
            if(!targetPath.exists())targetPath.mkdirs(); // 如果目录不存在：F://tmp/avatar/2021/10/27 递归创建
            // 6: 指定文件上传以后的服务器的完整的文件名
            File targetFileName = new File(targetPath,newFileName);// 文件上传以后在服务器上最终文件名和目录是：F://tmp/avatar/2021/10/27/SD23423k324-23423ms.jpg
            // 7: 文件上传到指定的目录
            multipartFile.transferTo(targetFileName);//将用户选择的aaa.jpg上传到F://tmp/avatar/2021/10/27/SD23423k324-23423ms.jpg
            // 可访问的路径要返回页面
            // http://localhpst:8777/bbs/2021/10/27/5f61dea2-4b77-4068-8d0b-fdf415eac6df.png
            String filename = dir+"/"+datePath+"/"+newFileName;
            return staticPath+"/"+filename;
        } catch (IOException e) {
            e.printStackTrace();
            return "fail";
        }
    }

}

```







#### 05、通过http请求服务资源

springboot如果去指定任意目录作为的资源的访问目录？

springboot有一个目录：static这个目录其实就是静态资源目录，这个目录下面的文件是可以通过http直接问题的。但是程序话一般打成jar包，我们没办法去文件写入到这个static下，所以springboot提供静态资源目录的额外的映射机制，就是静态资源服务映射。它就类似于：nginx的静态资源映射。

###### 01、配置静态资源服务的映射

```java
package com.kuangstudy.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebMvcCongfiguration implements WebMvcConfigurer {


    @Value("${file.staticPatternPath}")
    private String staticPatternPath;
    @Value("${file.uploadFolder}")
    private String uploadFolder;

    // 这个就是springboot中springMvc让程序开发者去配置文件上传的额外的静态资源服务的配置
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler(staticPatternPath).addResourceLocations("file:"+uploadFolder);
    }
}

```

核心代码分析

```java
registry.addResourceHandler("访问的路径").addResourceLocations("上传资源的路径");
registry.addResourceHandler("/uploadimg").addResourceLocations("file:F://tmp");
```

这个时候你把：aaa.png文件上传到了F://tmp 下，那么：你可以通过：http://localhost:8777/uploadimg/aaa.png



环境隔离配置

application-dev.yml

```yml
# 本机配置
file:
  staticPath: http://localhost:8777
  staticPatternPath: /upimages/**
  uploadFolder: F:/tmp/
```

application-prod.yml

```yml
# 服务器配置
file:
  staticPath: https://www.kuangstudy.com
  staticPatternPath: /upimages/**
  uploadFolder: /www/upload/
```

application.yml激活环境

```yml
server:
  port: 8777


spring:
  freemarker:
    suffix: .html
    cache: false
  profiles:
    active: dev
  servlet:
    multipart:
      enabled: true
      # 是单个文件大小 默认1M 10KB
      max-file-size: 2MB
      # 是设置总上传的数据大小
      max-request-size: 10MB
      #当文件达到多少时进行磁盘写入
      file-size-threshold: 20MB
      # 设置临时目录
      location: F://data//tempxxxxxxxxxxxx



```



在浏览器访问：

http://localhost:8777/upimages/bbs/2021/10/27/20560d68-c785-465c-bf2e-02e0de37e9ab.png

![img](asserts/20560d68-c785-465c-bf2e-02e0de37e9ab.png)







#### 06、对文件上传的思考和优化和控制

- 比如文件的格式
- 比如文件的大小
- 比如文件的重命名
- 比如文件的目录分类







































































